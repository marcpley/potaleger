name: Compile for Windows x64 (MinGW)
on:
  #[push]
  workflow_dispatch:
jobs:
  Build:
    runs-on: windows-2019

    steps:
      # 1️⃣ Installer Qt avec MinGW
      - name: Install Qt
        uses: jurplel/install-qt-action@v4.1.1
        with:
          version: 6.8.1
          host: 'windows'
          target: 'desktop'
          arch: 'mingw_64'
          cache: false

      # 2️⃣ Ajouter Qt au PATH (comme dans ton workflow original)
      - name: Add Qt to PATH
        shell: pwsh
        run: |
          $qtBinDir = "$env:Qt6_DIR\bin"
          echo "Adding $qtBinDir to PATH"
          [Environment]::SetEnvironmentVariable("PATH", "$env:PATH;$qtBinDir", [System.EnvironmentVariableTarget]::Process)

      # 3️⃣ Vérifier que qmake est bien trouvé
      - name: Check qmake
        shell: pwsh
        run: |
          qmake -v

      # 4️⃣ Installer MinGW avec MSYS2
      - name: Install MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain

      # 5️⃣ Vérifier que MinGW est bien installé
      - name: Check MinGW
        shell: msys2 {0}
        run: |
          gcc --version
          mingw32-make --version

      # 6️⃣ Cloner le dépôt
      - name: Checkout repository
        uses: actions/checkout@v4

      # 7️⃣ Compilation avec qmake et mingw32-make
      - name: Build
        shell: msys2 {0}
        run: |
          mkdir build
          cd build
          qmake ../potaleger.pro "QT += svg"
          mingw32-make

      # 8️⃣ Préparation de l'artifact
      - name: Prepare artifact
        shell: msys2 {0}
        run: |
          mkdir -p artifact/bin
          cp ./build/potaleger.exe artifact/bin/
          cp /mingw64/bin/Qt6Core.dll artifact/bin/
          cp /mingw64/bin/Qt6Gui.dll artifact/bin/
          cp /mingw64/bin/Qt6Widgets.dll artifact/bin/
          cp /mingw64/bin/Qt6Svg.dll artifact/bin/

      # 9️⃣ Upload de l'exécutable
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: potaleger0100windows
          path: artifact
