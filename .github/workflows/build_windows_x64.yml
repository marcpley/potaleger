name: Compile for Windows x64 (MinGW)
on: [push]

jobs:
  Build:
    runs-on: windows-2019

    steps:
      - name: Install MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-qt6-base
            mingw-w64-x86_64-qt6-svg

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Qt environment
        shell: msys2 {0}
        run: |
          export QT_DIR=/mingw64
          export QT_PLUGIN_PATH=/mingw64/lib/qt6/plugins
          export QT_QPA_PLATFORM_PLUGIN_PATH=/mingw64/lib/qt6/plugins/platforms
          export PATH=/mingw64/bin:$PATH
          echo "Qt environment set up"

      - name: Check qmake
        shell: msys2 {0}
        run: |
          which qmake
          qmake -v


      - name: Build
        shell: msys2 {0}
        run: |
          mkdir build
          cd build
          qmake ../potaleger.pro "QT += svg"
          mingw32-make

      - name: Prepare artifact
        shell: msys2 {0}
        run: |
          mkdir -p artifact/bin
          mkdir -p artifact/bin/plugins/platforms
          cp ./build/potaleger.exe artifact/bin/
          cp /mingw64/bin/Qt6Core.dll artifact/bin/
          cp /mingw64/bin/Qt6Gui.dll artifact/bin/
          cp /mingw64/bin/Qt6Widgets.dll artifact/bin/
          cp /mingw64/bin/Qt6Svg.dll artifact/bin/
          cp /mingw64/lib/qt6/plugins/platforms/qwindows.dll artifact/bin/plugins/platforms/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: potaleger0100windows
          path: artifact
